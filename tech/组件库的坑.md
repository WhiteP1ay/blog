# 记一个组件库相关的坑

我们的组件库因为和大多数项目的技术栈保持一致，所以组件库的发包没有打包流程。  
在调试的时候直接通过 yarn link 连接到项目，没有任何问题。  
在部署上线的时候通常也不会遇到问题，但今天不凑巧让我遇到了。

### 什么问题

富文本编辑器，在粘贴链接时的表现在组件库中和项目打包上线后不一致

### 排查过程

通常富文本都是单独部署，然后通过 iframe 嵌入到项目中（避免样式污染等副作用），但我们没有这么做。  
因为该富文本有些需求是根据业务定制的，不具有通用性，且通过 iframe 嵌入会导致组件通讯变得麻烦。  
所以我首先考虑是不是项目中的 css/js 影响了粘贴的行为。  
我把富文本从它的父级组件中取出，避免其他组件可能对其造成的影响，但问题没有解决。  
这是意料之中的，因为我知道理论上这些组件不会去影响组件的行为

### 解决方案

我把富文本编辑器的包删掉重新安装了一下，观察只有 yarn.lock 锁文件发生了变化，但行为终于一致了。  
显然是富文本编辑器包的依赖或依赖的依赖版本发生了变化。  
但组件库发包的时候通常不会把锁文件也发出去（因为我们组件库是基于 pnpm 做的，但项目又是 yarn，及时把锁文件发出去也没有用），所以导致依赖和依赖的依赖的版本是不固定的，除非打包后再发包。

### 后记

1. 看来我得试图说服 leader 改一下组件库的架构了
2. [发包的时候 package-lock.json 不会跟着发出去](https://stackoverflow.com/questions/44546718/should-package-lock-json-also-be-published),所以似乎除了组件库发布前打包无解了。
